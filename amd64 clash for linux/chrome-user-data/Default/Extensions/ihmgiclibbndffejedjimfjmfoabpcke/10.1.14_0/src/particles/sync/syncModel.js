!function(){const e=7500;pl.extend(ke.particles.sync.model,{syncHistory:function(r){var t=ke.ext.util.storageUtil.getVal("account_token");t?ke.idb.enum("it","history",Number.MAX_VALUE,null,!0,(function(o){var s=[],n=[],a=[],d={},i=[];o.forEach((function(e){d[e.time]=e.id,pl.type(e.server_id,"int")?e.pending_removal?(s.push(e.server_id),i.push(e.id)):n.push(e.server_id):e.pending_removal||a.push({timestamp:e.time,json:e.it_resp})})),$.ajax({url:"https://"+ke.syncServer+"/hist_sync",type:"POST",dataType:"JSON",headers:{"Content-Type":"application/json"},data:JSON.stringify({lang:ke.browserLang,token:t,ids_to_delete:s,local_server_ids:n,translations:a}),success:function(t){var o=0,s=0,n=0,a=!1;if(!t.deletion.error&&t.deletion.deletion_succeeded)if(i.length>0&&++o,ke.idb.del("it","history",i,(function(){++s})),++n,t.download.error)r({error:!0,message:ke.getLocale("Sync_SyncFailedError")+t.download.reason});else if(t.download.translations.forEach((function(e){++o,a=!0,ke.ext.cache.saveOrUpdate(e.json[5],e.json[6],e.json[1],e.json,"adev",(function(){++s}),e)})),++n,t.download.deleted.forEach((function(e){++o,a=!0,ke.idb.exists("it","history",["server_id",e],{},(function(e,r){e?ke.idb.del("it","history",[r],(function(){++s})):++s}))})),++n,t.upload.error)r({error:!0,message:ke.getLocale("Sync_SyncFailedError")+t.upload.reason});else{t.upload.server_ids.forEach((function(e){++o,ke.idb.update("it","history",d[e.timestamp],{server_id:e.server_id},(function(){++s}))})),++n;var l=Date.now(),c=setInterval((function(){(4===n&&s>=o||Date.now()-l>=e)&&(clearInterval(c),r({error:!1,downloaded:t.download.translations.length,uploaded:t.upload.server_ids.length,add_rm_changes:a}))}),10)}else r({error:!0,message:ke.getLocale("Sync_SyncFailedError")+t.deletion.reason})},error:function(e){r({error:!0,message:ke.getLocale("Sync_NetworkError")})}})})):r({error:!0,message:ke.getLocale("Sync_NotSignedInError")})},uploadHistoryItems:function(r,t){var o=ke.ext.util.storageUtil.getVal("account_token");if(o)if(0!==r.length){for(var s={},n=0,a=r.length;n<a;++n)s[r[n].timestamp]=r[n].id,delete r[n].id;$.ajax({url:"https://"+ke.syncServer+"/hist_upload",type:"POST",dataType:"JSON",headers:{"Content-Type":"application/json"},data:JSON.stringify({lang:ke.browserLang,token:o,translations:r}),success:function(r){var o=0,n=0;if(r.error)t({error:!0,message:ke.getLocale("Sync_SyncFailedError")});else{r.server_ids.forEach((function(e){++o,ke.idb.update("it","history",s[e.timestamp],{server_id:e.server_id},(function(){++n}))}));var a=Date.now(),d=setInterval((function(){(n===o||Date.now()-a>=e)&&(clearInterval(d),t({error:!1}))}),10)}},error:function(e){t({error:!0,message:ke.getLocale("Sync_NetworkError")})}})}else t({error:!0,message:ke.getLocale("Sync_NoItemsError")});else t({error:!0,message:ke.getLocale("Sync_NotSignedInError")})},deleteHistoryItems:function(e,r){var t=ke.ext.util.storageUtil.getVal("account_token");if(t)if(0!==e.length){for(var o=[],s=[],n=0,a=e.length;n<a;++n)o.push(e[n].id),s.push(e[n].server_id);$.ajax({url:"https://"+ke.syncServer+"/hist_delete",type:"POST",dataType:"JSON",headers:{"Content-Type":"application/json"},data:JSON.stringify({lang:ke.browserLang,token:t,ids_to_delete:s}),success:function(e){!e.error&&e.deletion_succeeded?ke.idb.del("it","history",o,(function(){r({error:!1})})):r({error:!0,message:ke.getLocale("Sync_SyncFailedError")})},error:function(e){r({error:!0,message:ke.getLocale("Sync_NetworkError")})}})}else r({error:!0,message:ke.getLocale("Sync_NoItemsError")});else r({error:!0,message:ke.getLocale("Sync_NotSignedInError")})},syncPhrasebook:function(r){var t=ke.ext.util.storageUtil.getVal("account_token");t?ke.idb.enum("it","wordlists",Number.MAX_VALUE,null,!0,(function(o){var s=[],n=[],a=[],d=[],i=[],l={},c={},u=0;o.forEach((function(e){e.server_id?c[e.last_update]=e.id:c[e.created]=e.id,ke.idb.search("it","phrases",{parent_wordlist_key:e.id},(function(r){if(e.server_id){var t=[],o=[],c=[];r.forEach((function(e){l[e.added]=e.id,e.server_id?e.pending_removal?(i.push(e.id),c.push(e.server_id)):t.push(e.server_id):o.push({id:e.id,added:e.added,json:e.json})})),e.pending_removal?(d.push(e.id),s.push({r:!0,id:e.server_id,words:t.concat(c)})):n.push({id:e.server_id,words:t}),c.length>0&&(++u,s.push({r:!1,id:e.server_id,words:c})),o.length>0&&(++u,a.push({id:e.id,server_id:e.server_id,last_update:e.last_update,words:o}))}else if(e.pending_removal)--u;else{var p=[];r.forEach((function(e){l[e.added]=e.id,p.push({added:e.added,json:e.json})})),a.push({timestamp:e.created,last_update:e.last_update,from:e.from,to:e.to,name:e.name,words:p})}}))}));var p=Date.now(),_=setInterval((function(){s.length+n.length+a.length-u===o.length?(clearInterval(_),ke.particles.sync.model.sendAndHandlePhrasebookSyncRequest(t,s,n,a,d,i,c,l,r)):Date.now()-p>=e&&(clearInterval(_),r({error:!0,message:ke.getLocale("Sync_UnknownError")}))}))})):r({error:!0,message:ke.getLocale("Sync_NotSignedInError")})},sendAndHandlePhrasebookSyncRequest:function(r,t,o,s,n,a,d,i,l){$.ajax({url:"https://"+ke.syncServer+"/pb_sync",type:"POST",dataType:"JSON",headers:{"Content-Type":"application/json"},data:JSON.stringify({lang:ke.browserLang,token:r,to_del:t,local_wl_ids:o,wordlists:s}),success:function(r){var t=0,o=0,s=0,c=0,u=!1;if(r.error)l({error:!0,message:ke.getLocale("Sync_PbGeneralError")});else if(r.deleted.success)if(n.length>0&&++t,ke.idb.del("it","wordlists",n,(function(){++o})),a.length>0&&++t,ke.idb.del("it","phrases",a,(function(){++o})),pl.type(r.to_delete,"arr"))if(r.to_delete.forEach((function(e){++t,u=!0,ke.idb.exists("it","wordlists",["server_id",e.id],{},(function(r,n){r&&(e.r?(++t,ke.idb.del("it","wordlists",[n],(function(){++o})),++t,ke.idb.findAndDel("it","phrases",{parent_wordlist_key:n},(function(){++o}))):(++c,e.words.forEach((function(e){++t,ke.idb.findAndDel("it","phrases",{server_id:e},(function(){++o}))})),++s,++t,ke.idb.update("it","wordlists",n,{phrases_count:{update_type:ke.idb.ARITH_ADD_UPDATE_TYPE,value:-e.words.length}},(function(){++o})))),++o}))})),++s,r.to_download.error)l({error:!0,message:ke.getLocale("Sync_SyncFailedError")});else{var p=function(e,r){r.forEach((function(r){++t,ke.idb.add("it","phrases",{parent_wordlist_key:e,text:r.json[1],translation:r.json[3],json:r.json,added:r.added,server_id:r.server_id,usageExample:"",pending_removal:!1},"phrase",(function(e,r){++o}))})),++s};r.to_download.items.forEach((function(e){++t,u=!0,e.timestamp?ke.idb.add("it","wordlists",{from:e.from,to:e.to,name:e.name,last_update:e.last_update,created:e.timestamp,phrases_count:e.words.length,server_id:e.server_id,pending_removal:!1},"wordlist",(function(r,t){++o,++c,p(r,e.words)})):ke.idb.findAndUpdate("it","wordlists",{server_id:e.server_id},{last_update:e.last_update,phrases_count:{update_type:ke.idb.ARITH_ADD_UPDATE_TYPE,value:+e.words.length}},(function(r){0!==r.length?(++o,++c,p(r[0].id,e.words)):++o}))})),++s,++t,ke.particles.sync.model.handleUploadWordlistsResponse(d,i,r.uploaded,(function(e){e.error?l(e):++o}));var _=Date.now(),g=setInterval((function(){(s===2+c&&o===t||Date.now()-_>=e)&&(clearInterval(g),l({error:!1,add_rm_changes:u}))}),10)}else l({error:!0,message:ke.getLocale("Sync_SyncFailedError")});else l({error:!0,message:ke.getLocale("Sync_PbDeleteError")})},error:function(e){l({error:!0,message:ke.getLocale("Sync_NetworkError")})}})},uploadWordlists:function(e,r){var t=ke.ext.util.storageUtil.getVal("account_token");if(t)if(0!==e.length){var o=ke.particles.sync.model.mapPhrasebookUploadIds(e);$.ajax({url:"https://"+ke.syncServer+"/wl_upload",type:"POST",dataType:"JSON",headers:{"Content-Type":"application/json"},data:JSON.stringify({lang:ke.browserLang,token:t,wordlists:e}),success:function(e){ke.particles.sync.model.handleUploadWordlistsResponse(o.t2ids,o.t2words,e,r)},error:function(e){r({error:!0,message:ke.getLocale("Sync_NetworkError")})}})}else r({error:!0,message:ke.getLocale("Sync_NoItemsError")});else r({error:!0,message:ke.getLocale("Sync_NotSignedInError")})},mapPhrasebookUploadIds:function(e){for(var r={},t={},o=0,s=e.length;o<s;++o){r[e[o].timestamp||e[o].last_update]=e[o].id,delete e[o].id;for(var n=0,a=e[o].words.length;n<a;++n)t[e[o].words[n].added]=e[o].words[n].id,delete e[o].words[n].id}return{t2ids:r,t2words:t}},handleUploadWordlistsResponse:function(r,t,o,s){var n=0,a=0,d=0,i=0,l=function(e,o,s,d){ke.idb.update("it","wordlists",r[e[s]],o,(function(){++a})),e[d].forEach((function(e){++n,ke.idb.update("it","phrases",t[e.added],{server_id:e.server_id},(function(){++a}))})),++i};o.new_lists&&(o.new_lists.forEach((function(e){e.error||(++n,++d,l(e,{server_id:e.server_id},"timestamp","words"))})),++i),o.updated_lists&&(o.updated_lists.forEach((function(e){e.error||(++n,++d,l(e,{server_id:e.server_id,last_update:e.last_update},"last_update","words_ids"))})),++i);var c=Date.now(),u=setInterval((function(){(i===2+d&&a===n||Date.now()-c>=e)&&(clearInterval(u),s({error:!1}))}),10)},uploadWords:function(e,r){var t=ke.ext.util.storageUtil.getVal("account_token");if(t)if(0!==e.length){var o=ke.particles.sync.model.mapPhrasebookUploadIds(e);$.ajax({url:"https://"+ke.syncServer+"/wl_upload",type:"POST",dataType:"JSON",headers:{"Content-Type":"application/json"},data:JSON.stringify({lang:ke.browserLang,token:t,wordlists:e}),success:function(e){e.error?console.error(e.reason):ke.particles.sync.model.handleUploadWordlistsResponse(o.t2ids,o.t2words,e)}})}else r({error:!0,message:ke.getLocale("Sync_NoItemsError")});else r({error:!0,message:ke.getLocale("Sync_NotSignedInError")})},deleteWordlists:function(e,r){var t=ke.ext.util.storageUtil.getVal("account_token");if(t)if(0!==e.length){for(var o=[],s=[],n=0,a=e.length;n<a;++n)e[n].r&&o.push(e[n]._id),s.push(e[n]._words),delete e[n]._id,delete e[n]._words;$.ajax({url:"https://"+ke.syncServer+"/wl_delete",type:"POST",dataType:"JSON",headers:{"Content-Type":"application/json"},data:JSON.stringify({lang:ke.browserLang,token:t,to_del:e}),success:function(e){e.success?ke.idb.del("it","wordlists",o,(function(){ke.idb.del("it","phrases",s,(function(){r({error:!1})}))})):r({error:!0,message:ke.getLocale("Sync_SyncFailedError")})}})}else r({error:!0,message:ke.getLocale("Sync_NoItemsError")});else r({error:!0,message:ke.getLocale("Sync_NotSignedInError")})}})}();