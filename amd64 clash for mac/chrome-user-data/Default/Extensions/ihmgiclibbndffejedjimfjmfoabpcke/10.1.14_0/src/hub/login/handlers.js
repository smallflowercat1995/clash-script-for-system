pl.extend(ke.app.handlers,{checkUser:function(){var e=$(".email").val();ke.ext.string.isValidEmail(e)?ke.app.flags.checking||("undefined"!=typeof ga&&ga("send","event","login","check-user"),ke.app.flags.checking=!0,$(".check-user").hide(),$(".check-user-loading").show(),$.ajax({url:"https://"+ke.syncServer+"/check_user",type:"GET",dataType:"json",data:{lang:ke.browserLang,email:e},success:function(n){if(ke.app.temp.checked_email=e,$(".check-user-loading").hide(),$(".check-user").show(),n.error)return"undefined"!=typeof ga&&ga("send","event","login","check-user-failed"),void alert(ke.ext.string.safeResponse.cleanDomString(n.reason));"undefined"!=typeof ga&&ga("send","event","login","check-user-success"),ke.app.flags.checking=!1,$(".checked-email").html(e),$(".check-user-screen").hide(),n.registered?($(".sign-in-screen").show(),$(".si-pwd").focus()):($(".sign-up-screen").show(),$(".name").focus())},error:function(e){$(".check-user-loading").hide(),$(".check-user").show(),"undefined"!=typeof ga&&ga("send","event","login","check-user-failed"),alert("Unknown error.")}})):pl(".email").highlightErrorFor(200)},close:function(){ke.ext.util.storageUtil.requestBackgroundOption("setVal",["supress_signin",!0]),chrome.runtime.sendMessage({action:ke.processCall("app","opt","closeLoginPopup")})},handleLoginResponses:function(e){var n=ke.parseProcessCall(e.action);"app"===n.lib&&"login"===n.cmd&&"finish"===n.exact&&ke.app.handlers.finishLoginWithSocials(e.data)},openPrivacyPolicy:function(){chrome.tabs.create({url:"https://gikken.co/mate-translate/privacy/?ref="+ke.browserName,active:!0})},openPasswordReset:function(){chrome.tabs.create({url:"https://gikken.co/mate-translate/forgot-password/",active:!0})},signIn:function(){var e=$(".si-pwd").val();if(e){if(!ke.app.flags.signing_in){"undefined"!=typeof ga&&ga("send","event","login","sign-in"),ke.app.flags.signing_in=!0;var n=$(".sign-in");n.hide(),$(".sign-up-loading").show(),ke.getDeviceData((function(t){$.ajax({url:"https://"+ke.syncServer+"/login",type:"GET",dataType:"JSON",data:$.extend({lang:ke.browserLang,method:"e",email:ke.app.temp.checked_email,pwd:e},t),success:function(e){if($(".sign-up-loading").hide(),n.show(),ke.app.flags.signing_in=!1,e.error)"undefined"!=typeof ga&&ga("send","event","login","sign-in-failed"),alert(e.reason);else{"undefined"!=typeof ga&&ga("send","event","login","sign-in-success"),ke.ext.util.storageUtil.chainRequestBackgroundOption([{fn:"setVal",args:["account_name",e.name]},{fn:"setVal",args:["account_email",ke.app.temp.checked_email]},{fn:"setVal",args:["account_token",e.token]}]);let n=ke.ext.util.storageUtil.getDecodedVal("temp_sub_data");n.signed_in_before=!0,ke.ext.util.storageUtil.encodeAndSet("temp_sub_data",n),e.subscriptionInfo&&(ke.particles.pro_block.model.sendChargedEventIfNeeded(e.subscriptionInfo),ke.ext.util.storageUtil.requestBackgroundOption("encodeAndSet",["sub_data",e.subscriptionInfo])),e.has_pro&&ke.ext.util.storageUtil.requestBackgroundOption("setVal",["chr_pro_flag",!0]),chrome.runtime.sendMessage({action:ke.processCall("app","opt","updateUninstallUri")}),ke.app.handlers.close()}},error:function(e){$(".sign-up-loading").hide(),n.show(),"undefined"!=typeof ga&&ga("send","event","login","sign-in-failed"),alert("Unknown error.")}})}))}}else pl(".si-pwd").highlightErrorFor(200)},signUp:function(){var e=$(".su-pwd").val(),n=$(".name").val();if(e.length<8)alert(ke.getLocale("Login_PasswordMin8"));else if(!ke.app.flags.signing_up){"undefined"!=typeof ga&&ga("send","event","login","sign-up"),ke.app.flags.signing_up=!0;var t=$(".sign-up");t.hide(),$(".sign-up-loading").show(),ke.getDeviceData((function(a){let i,s;ke.app.flags.finishing_account?(s={lang:ke.browserLang,name:encodeURIComponent(n),password:encodeURIComponent(e),code:ke.ext.util.storageUtil.getVal("temp_signup_code"),needs_token:!0},i="finish_signup"):(s={lang:ke.browserLang,email:ke.app.temp.checked_email,pwd:encodeURIComponent(e),name:encodeURIComponent(n)},i="register_user"),$.ajax({url:"https://"+ke.syncServer+"/"+i,type:"GET",dataType:"JSON",data:$.extend(s,a),success:function(e){if(ke.app.flags.signing_up=!1,$(".sign-up-loading").hide(),t.show(),e.error)"undefined"!=typeof ga&&ga("send","event","login","sign-up-failed"),alert(e.reason);else{if("undefined"!=typeof ga&&ga("send","event","login","sign-up-success"),ke.ext.util.storageUtil.chainRequestBackgroundOption([{fn:"setVal",args:["account_name",n]},{fn:"setVal",args:["account_email",ke.app.temp.checked_email]},{fn:"setVal",args:["account_token",e.token]}]),e.subscriptionInfo&&ke.ext.util.storageUtil.requestBackgroundOption(["encodeAndSet","sub_data",e.subscriptionInfo]),ke.ext.util.storageUtil.requestBackgroundOption(["setVal","chr_pro_flag",!!e.has_pro]),ke.app.flags.finishing_account){let e=ke.ext.util.storageUtil.getDecodedVal("temp_sub_data");e.signed_in_before=!0,ke.ext.util.storageUtil.encodeAndSet("temp_sub_data",e),ke.ext.util.storageUtil.setVal("temp_signup_code",null)}ke.app.handlers.close()}},error:function(e){$(".sign-up-loading").hide(),t.show(),"undefined"!=typeof ga&&ga("send","event","login","sign-up-failed"),alert("Unknown error.")}})}))}},back:function(){$(".sign-in-screen").hide(),$(".sign-up-screen").hide(),$(".check-user-screen").show()},toggleCheckbox:function(){$(this).toggleClass("checked"),$(".agree").prop("disabled",(function(e,n){return!n}))},agreeGDPR:function(){ke.ext.util.storageUtil.requestBackgroundOption("setVal",["gdpr_consent",!0]),$(".agree").hide(),$(".gdpr-loading").show(),ke.app.handlers.accepted=!0,ke.ext.util.storageUtil.requestBackgroundOption("getVal",["account_token"],(function(e){e?($.ajax({url:"https://"+ke.syncServer+"/accept_gdpr",type:"GET",dataType:"json",data:{token:e,accept:!0},success:function(e){window.close()},error:function(){window.close()}}),"undefined"!=typeof ga&&ga("send","event","gdpr","signed-in-user-accept")):("undefined"!=typeof ga&&ga("send","event","gdpr","anonymous-user-accept"),"#gdpr"===document.location.hash?window.close():document.location.reload())}))},skip:function(){"undefined"!=typeof ga&&ga("send","event","login","skip"),ke.app.handlers.close()},showLoginInfo:function(){$(".info-window").fadeIn(200),"undefined"!=typeof ga&&ga("send","event","login","show-login-info")},closeLoginInfo:function(){$(".info-window").fadeOut(200)},onEmailEnter:function(e){13===e.keyCode&&ke.ext.event.isDown("enter",ke.ext.event.IN_STR)&&ke.app.handlers.checkUser()},onSignInEnter:function(e){13===e.keyCode&&ke.ext.event.isDown("enter",ke.ext.event.IN_STR)&&ke.app.handlers.signIn()},onSignUpPwdEnter:function(e){13===e.keyCode&&ke.ext.event.isDown("enter",ke.ext.event.IN_STR)&&ke.app.handlers.signUp()},onSignUpNameEnter:function(e){13===e.keyCode&&ke.ext.event.isDown("enter",ke.ext.event.IN_STR)&&$(".su-pwd").focus()},onResize:function(){window.resizeTo(550,470)},accepted:!1,onGDPRBeforeUnload:function(){ke.app.handlers.accepted||chrome.runtime.sendMessage({action:ke.processCall("app","commands","sendAnalyticsEvent"),cat:"gdpr",event:"window-close"})}});