pl.extend(ke.app.handlers,{_processEventHandlers:{app:{opt:{},translate:{},audio:{},option:{},commands:{},sync:{},phrasebook:{}}},onCommandReceived:function(e,t,n){if(e.action){var a=ke.parseProcessCall(e.action),s=ke.app.handlers._processEventHandlers;return s[a.lib]&&s[a.lib][a.cmd]&&ke.app.handlers._processEventHandlers[a.lib][a.cmd][a.exact](e,(function(t){void 0!==t&&void 0!==e&&pl.extend(t,{old_data:e});try{n(t)}catch(e){}}),t),!0}},detectCountry:function(e){Date.now()-ke.ext.util.storageUtil.getIntValue("last_country_fetch_2")>=864e5?navigator.onLine?$.ajax({url:"https://api2.matetranslate.com/geo/json",type:"GET",success:function(t){t=t.toLowerCase(),ke.ext.util.storageUtil.setVal("user_country",t),ke.ext.util.storageUtil.setOptionAsBoolean("mon_is_cis",ke.app.handlers.isCIS(t)),ke.ext.util.storageUtil.setIntValue("last_country_fetch_2",Date.now()),e()},error:function(e){}}):window.addEventListener("online",(function(){ke.app.handlers.detectCountry(e)})):e()},finishCheckout:function(e){$.ajax({url:"https://checkout.paddle.com/api/1.0/order",method:"GET",data:{checkout_id:e},success:t=>{"processing"===t.state?setTimeout((()=>{ke.app.handlers.finishCheckout(e)}),1e3):"processed"===t.state&&chrome.tabs.query({},(function(e){let n=!1;e.forEach((function(e){e.url&&e.url.indexOf("/pages/public/options.html")>-1&&(chrome.tabs.sendMessage(e.id,{action:ke.processCall("app","pro","finish-checkout"),email:t.order.customer.email}),n=!0)})),n||chrome.tabs.create({url:chrome.extension.getURL("/pages/public/options.html")},(e=>{chrome.tabs.sendMessage(e.id,{action:ke.processCall("app","pro","finish-checkout"),email:t.order.customer.email})}))}))},error:e=>{console.log(e)}})},getProPrice:function(e){Date.now()-ke.ext.util.storageUtil.getIntValue("last_price_fetch_2")>=3456e5?navigator.onLine?$.ajax({url:"https://checkout.paddle.com/api/2.0/prices",type:"GET",crossDomain:!0,data:{product_ids:[ke.ext.const.subscriptions.ONE_OFF_ID,ke.ext.const.subscriptions.ANNUAL_PLAN_ID,ke.ext.const.subscriptions.MONTHLY_PLAN_ID].join(","),quantity:1},dataType:"json",success:function(t){t.success&&(t.response.products.forEach((e=>{const t=e.list_price.gross+" "+e.currency;e.product_id===ke.ext.const.subscriptions.ONE_OFF_ID?ke.ext.util.storageUtil.setVal("pro_inapp_price",t):e.product_id===ke.ext.const.subscriptions.ANNUAL_PLAN_ID?ke.ext.util.storageUtil.setVal("sub_price_annual",t):e.product_id===ke.ext.const.subscriptions.MONTHLY_PLAN_ID&&ke.ext.util.storageUtil.setVal("sub_price_monthly",t)})),ke.ext.util.storageUtil.setIntValue("last_price_fetch_2",Date.now())),e()},error:function(t){console.log(t),e()}}):window.addEventListener("online",(function(){ke.app.handlers.getProPrice(e)})):e()},isCIS:function(e){return ke.DEBUG,e in{by:0,kz:0,ru:0,ua:0}||ke.getCurrentLocale()in{ru:0,uk:0}},generateDropdownHtml:function(e){},opened_internal_pages:{},internal_redir_blocked:!1,checkInternalPagesRedirect:function(e,t){if(!ke.app.handlers.internal_redir_blocked){var n,a=(ke.redirectableExtId+".com/").toLowerCase();if(ke.IS_FIREFOX&&(n=(ke.staticExtId.split("@")[0]+".com/").toLowerCase()),t.url&&t.url.indexOf(a+"finish_checkout")>-1){const n=t.url.split("?")[1].split("&")[0].split("=")[1];ke.app.handlers.finishCheckout(n),e&&chrome.tabs.remove(e)}else if(t.url&&(t.url.indexOf(a)>-1||n&&t.url.indexOf(n)>-1)){ke.app.handlers.internal_redir_blocked=!0,chrome.tabs.remove(e);var s=ke.pathToExt+t.url.replace(a,"").replace(n,"").replace("http://","").replace("https://","");chrome.tabs.create({url:chrome.extension.getURL(s)},(function(){ke.app.handlers.internal_redir_blocked=!1}))}}},checkInternalPagesRedirectSafari:function(e,t,n){chrome.tabs.query({},(function(e){e.forEach((function(e){e.url&&ke.app.handlers.checkInternalPagesRedirect(e.id,e)}))}))},submitTranslationCounters:function(e){if(Date.now()-ke.ext.util.storageUtil.getIntValue("char_stats_last_update")>=864e5)if(navigator.onLine){let e=ke.ext.util.storageUtil.getDecodedVal("char_stats");$.ajax({url:"https://asia.gikken.co/mateapi/v2/save_character_stats",type:"POST",dataType:"JSON",headers:{"Content-Type":"application/json"},data:JSON.stringify({client_time:Date.now(),is_pro:ke.isProUser,chars_total:e.total,translations:e.translations,chars_per_pair:e.chars_per_pair,platform:ke.PLATFORM_CODE,ver:ke.ext.util.storageUtil.getVal("ext_ver"),uid:ke.ext.util.storageUtil.getVal("user_id"),e:ke.ext.util.storageUtil.getVal("account_email")}),success:e=>{e.success&&(ke.ext.util.storageUtil.encodeAndSet("char_stats",{total:0,translations:0,chars_per_pair:{}}),ke.ext.util.storageUtil.setIntValue("char_stats_last_update",Date.now()))},error:e=>{console.log(e)}})}else window.addEventListener("online",(function(){ke.app.handlers.submitTranslationCounters(e)}))},checkSponsorships:function(){Date.now()-ke.ext.util.storageUtil.getIntValue("sponsorships_last_update")>=2592e5&&(navigator.onLine?$.ajax({url:"https://gikken.co/files/mate/sponsorships.json",type:"GET",dataType:"json",success:e=>{ke.ext.util.storageUtil.encodeAndSet("sponsorships",e),ke.ext.util.storageUtil.setIntValue("sponsorships_last_update",Date.now())},error:e=>{console.log("Could not get sponsorship ads:",e)}}):window.addEventListener("online",(function(){ke.app.handlers.checkSponsorships()})))},checkToken:function(e,t){let n=ke.ext.util.storageUtil.getVal("account_token");n?ke.getDeviceData((function(a){$.ajax({url:"https://"+ke.syncServer+"/check_token",type:"GET",dataType:"json",data:$.extend({token:n,gdpr_consent:ke.ext.util.storageUtil.isTrueOption("gdpr_consent")},a),success:function(n){n&&!n.error&&n.valid&&!n.expired?(e(),n.user_info&&ke.ext.util.storageUtil.setVal("chr_pro_flag",n.user_info.has_pro),n.user_info.subscriptionInfo&&(ke.particles.pro_block.model.sendChargedEventIfNeeded(n.user_info.subscriptionInfo),ke.ext.util.storageUtil.encodeAndSet("sub_data",n.user_info.subscriptionInfo))):n.valid&&!n.expired||(ke.ext.util.storageUtil.setVal("account_email",""),ke.ext.util.storageUtil.setVal("account_token",""),ke.ext.util.storageUtil.setVal("account_name","")),t()},error:function(){t()}})})):t()},checkWhetherNotificationsShouldBePushed:function(){if(!ke.ext.util.storageUtil.isTrueOption("sub_48h_notif")||1===ke.ext.util.storageUtil.getIntValue("sub_48h_notif_status")||0===ke.ext.util.storageUtil.getIntValue("sub_trial_days"))return;let e=setInterval((()=>{if(console.log("notif interval, status="+ke.ext.util.storageUtil.getIntValue("sub_48h_notif_status")),0!==ke.ext.util.storageUtil.getIntValue("sub_48h_notif_status"))return;let t=ke.ext.util.storageUtil.getIntValue("sub_trial_starting_date")+864e5*ke.ext.util.storageUtil.getIntValue("sub_trial_days")-1728e5,n=ke.ext.util.storageUtil.getDecodedVal("sub_data");Date.now()>=t&&"trialing"===n.status&&(chrome.permissions.contains({permissions:["notifications"]},(e=>{if(e){let e="Monthly";n.subscription_plan_id==ke.ext.const.subscriptions.ANNUAL_PLAN_ID&&(e="Annual");let t=n.unit_price+" "+n.currency;chrome.notifications.create(null,{type:"basic",iconUrl:chrome.runtime.getURL("res/images/icons/icon128@2x.png"),title:ke.getLocale("Sub_48hNotificationTitle"),message:ke.getLocale("Sub_48hNotificationBody"+e).replace("{{amount}}",t)},(()=>{"undefined"!=typeof ga&&ga("send","event","pro","48h-notifs","pushed")}))}else"undefined"!=typeof ga&&ga("send","event","pro","48h-notifs","wanted-to-push-but-no-permission")})),ke.ext.util.storageUtil.setIntValue("sub_48h_notif_status",1),clearInterval(e))}),18e5)},runSync:function(){ke.app.handlers.checkToken((function(){ke.canSync&&(ke.particles.sync.model.syncHistory((function(e){})),ke.particles.sync.model.syncPhrasebook((function(e){})))}),(function(){}))},pickFastestMateServer:function(e){const t=["https://api.matetranslate.com","https://api2.matetranslate.com","https://asia.gikken.co/mateapi"];let n=0,a=new Array(t.length).fill(0),s=new Ping;t.forEach(((o,i)=>{s.ping(o,(function(s,o){!function(s,o){if(++n,n===t.length){a[o]=s;let n=0;a.forEach(((e,t)=>{e<a[n]&&(n=t)})),ke.ext.util.storageUtil.setVal("misc_server",t[n]),(e||function(){})()}else a[o]=s}(o,i)}))}))},checkIfMetaMaskUser:function(){if(ke.IS_CHROME&&-1===ke.ext.util.storageUtil.getIntValue("_is_metamask_user"))try{fetch("chrome-extension://nkbihfbeogaeaoehlefnkodbefgpgknn/inpage.js").then((e=>{e.ok?(console.log("MetaMask installed"),"undefined"!=typeof ga&&ga("send","event","_metamask","installed"),ke.ext.util.storageUtil.setIntValue("_is_metamask_user",1)):(console.log("MetaMask not installed"),"undefined"!=typeof ga&&ga("send","event","_metamask","not-installed"),ke.ext.util.storageUtil.setIntValue("_is_metamask_user",0))})).catch((e=>{console.log("MetaMask not installed"),"undefined"!=typeof ga&&ga("send","event","_metamask","not-installed"),ke.ext.util.storageUtil.setIntValue("_is_metamask_user",0)}))}catch(e){console.log("MetaMask not installed"),"undefined"!=typeof ga&&ga("send","event","_metamask","not-installed"),ke.ext.util.storageUtil.setIntValue("_is_metamask_user",0)}},loadMateFP:function(e,t){chrome.tabs.sendMessage(t.id,{action:ke.processCall("app","trans","fullPage")}),"undefined"!=typeof ga&&ga("send","event","translation","fullpage"),Date.now()-ke.ext.util.storageUtil.getIntValue("last_trans_count_upd")>=ke.TIME.ONE_DAY&&ke.app.handlers.sendTranslationsCount(),ke.ext.util.storageUtil.setJsonField("translations_count","fullpage",+ke.ext.util.storageUtil.getJsonField("translations_count","fullpage")+1),ke.ext.util.storageUtil.setJsonField("all_trans_count","fullpage",+ke.ext.util.storageUtil.getJsonField("all_trans_count","fullpage")+1),ke.app.handlers._processEventHandlers.app.opt.updateUninstallUri()},sendInstallEvent:function(){ke.ext.util.storageUtil.isTrueOption("install_event")||(ke.ext.util.storageUtil.setVal("install_event",!0),chrome.tabs.query({},(function(e){"undefined"!=typeof ga&&ga("send","event","background","install","tabs-"+e.length),$.ajax({url:"https://sync.matetranslate.com/add_dev",type:"GET",dataType:"json",data:{d_id:ke.ext.util.storageUtil.getVal("user_id"),d:ke.PLATFORM_CODE,l:ke.getLocale("@@ui_locale"),v:ke.ext.util.storageUtil.getVal("ext_ver"),tl:e.length},success:function(e){e.success&&"undefined"!=typeof ga&&ga("send","event","background","install","sent")},error:function(e){"undefined"!=typeof ga&&ga("send","event","background","install","failed")}})})))},sendTranslationsCount:function(){if(Date.now()-ke.ext.util.storageUtil.getIntValue("last_trans_count_upd")>=ke.TIME.ONE_DAY){var e=new Date,t=new Date(e.getYear(),e.getMonth(),e.getDate(),0,0,0,0),n=ke.ext.util.storageUtil.getDecodedVal("translations_count");$.ajax({url:"https://sync.matetranslate.com/save_analytics",type:"GET",dataType:"JSON",data:$.extend(n,{date:t.getTime(),user_id:ke.ext.util.storageUtil.getVal("user_id")}),success:function(e){e.success&&"undefined"!=typeof ga&&ga("send","event","background","trans-count","sent")},error:function(e){"undefined"!=typeof ga&&ga("send","event","background","trans-count","failed")}}),ke.ext.util.storageUtil.encodeAndSet("translations_count",ke.ext.const.storage.DEFAULT_VALUES.TRANSLATIONS_COUNT),ke.ext.util.storageUtil.setVal("last_trans_count_upd",Date.now())}}});