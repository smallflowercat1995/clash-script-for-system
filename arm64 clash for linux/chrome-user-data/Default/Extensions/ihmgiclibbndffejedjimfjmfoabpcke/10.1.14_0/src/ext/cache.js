ke.import("ext.string"),pl.extend(ke.ext.cache,{saveOrUpdate:function(e,t,i,n,o,r,s){r=r||ke.EF,ke.idb.exists("it","history",["input",i],{l_from:e,l_to:t},(function(a,l,d){if(a){var c=d.sources||{};c[o]=Date.now();var u={it_resp:n,sources:c};s&&(u.server_id=s.server_id),ke.idb.update("it","history",l,u,(function(){r()}))}else{var f={};f[o]=Date.now();var p=s?s.timestamp:Date.now();ke.idb.add("it","history",{l_from:e,l_to:t,input:i,it_resp:n,sources:f,server_id:s?s.server_id:null,pending_removal:!1,time:p},"translation",(function(e){r(),e&&!s&&ke.canSync&&ke.particles.sync.model.uploadHistoryItems([{id:e,timestamp:p,json:n}],(function(){}))}))}}))},lookUpInCache:function(e,t,i,n){ke.idb.exists("it","history",["input",i],{pending_removal:!1,l_from:e,l_to:t},(function(e,t,i){e?n(!1,i):n(!0)}))},getIdListOfAll:function(e){ke.idb.search("it","history",{pending_removal:!1},(function(t,i){if(!t&&i&&ke.IS_FIREFOX)ke.ui.loading.showIdbErrorLayout();else{for(var n=[],o=0,r=t.length;o<r;++o)n.push(t[o].id);e(n)}}))},deleteFewByIdOnClient:function(e,t){chrome.runtime.sendMessage({action:ke.processCall("app","sync","deleteHistoryItems"),ids:e},t)},deleteFewById:function(e,t){var i=[];if(ke.ext.util.storageUtil.getVal("account_token")){e.forEach((function(e){ke.idb.update("it","history",e,{pending_removal:!0},(function(e,t){i.push({id:t,server_id:e.server_id})}))}));var n=setInterval((function(){i.length===e.length&&(clearInterval(n),t(!0),ke.canSync&&ke.particles.sync.model.deleteHistoryItems(i,(function(e){e.error&&console.log(e.message)})))}),10)}else ke.idb.del("it","history",e,(function(){t(!0)}))}});